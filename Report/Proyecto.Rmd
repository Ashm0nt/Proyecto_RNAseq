---
output:
  pdf_document:
    toc: yes
    toc_depth: 5
    fig_caption: true
    keep_tex: true
    number_sections: true
    latex_engine: xelatex
    includes:
      before_body: portada.tex
fontsize: 11pt
mainfont: Arial
lang: es
header-includes:
  - \usepackage{float}
  - \usepackage{graphicx}
  - \usepackage{geometry}
  - \usepackage{float}
  - \floatplacement{figure}{H}
editor_options: 
  markdown: 
    wrap: 72
bibliography: References.bib
---

# Introducción

La metformina es el tratamiento de primera línea para la diabetes tipo 2 debido a su eficacia para disminuir la gluconeogénesis hepática y mejorar la sensibilidad a la insulina. Además de su acción antihiperglucémica, este fármaco presenta múltiples efectos pleiotrópicos en diversos procesos biológicos, entre ellos la inflamación, el estrés oxidativo, la senescencia celular, la autofagia y la apoptosis, todos estrechamente vinculados con el envejecimiento. Estudios epidemiológicos han sugerido un posible efecto geroprotector de la metformina, asociado con la reducción en la incidencia de enfermedades relacionadas con la edad, como las enfermedades cardiovasculares, distintos tipos de cáncer y padecimientos neurodegenerativos, así como con una disminución de la mortalidad independiente de sus efectos sobre el metabolismo de la glucosa.

El músculo esquelético desempeña un papel central en a homostasis metabólica del organismos y es particularmente suceptible a los cambios asociados al envejeciemiento. La peridad progresiva de masa y función celular, junto con alteraciones en la sensibilidad a la insulina y en la capacidad oxidativa, contribuyen al deterioro de la calidad de vida en adultos mayores. Comprender cómo la metformina modula la biología molecular del músculo esquelético puede aportar unformación clave sobre como los mecanismos mediante los cuaes este fármaco influye en la salud durante el envejecimiento. 


El conjunto de datos analizados en este proyecto se deriva del estudio de Kulkarni et al. (2018) generados a partir de muestras de músculo esquelético y tejido adiposo subcutáneo de adultos de aproximadamente 70 años de edad (n=14). El estudio original se diseñó como un ensayo aleatorizado, doble ciego, controlado con placebo y con esquema cruzado, en el cual los participantes recibieron seis semanas de tratamiento con metformina y seis semanas con placebo.

# Pregunta de investigación 

¿Qué cambios transcriptómicos se observan en el músculo esquelético de adultos mayores después de seis semanas de tratamiento con metformina?

# Análisis

Con la intención de elegir un proyecto disponible en recount3 para realizar un análisis de expresión diferencial, se conuslto la pagina de [recount3](https://rna.recount.bio/). Se eligió el proyecto SRP126485 "Metformin regulates metabolic and nonmetabolic pathways in skeletal muscle and subcutaneous adipose tissues of older adults". 

## Instalación y carga de paquetes

```{r load_packages, message=FALSE, warning=FALSE}

# Instalar Biocmanageer si no está intalado
if (!requireNamespace("BiocManager", quietly = TRUE)) {
    install.packages("BiocManager")
}

# Instalar paquetes de Bioconductor
#BiocManager::install(
#    c(
#        "edgeR", 
#        "ExploreModelMatrix",
#        "limma",
#        "recount3", 
#        "SummarizedExperiment", 
#        "GenomicRanges"
#    )
#)

# Instalar paquetes de CRAN
#install.packages(c(
#    "pheatmap", 
#    "patchwork",
#    "RColorBrewer",
#    "cowplot"
#))

## Cargar los paquetes
library("recount3")
library("SummarizedExperiment")
library("GenomicRanges")
library("limma")
library("edgeR")
library("ExploreModelMatrix")
library("variancePartition")
library("EnhancedVolcano")
library("cowplot")
library("RColorBrewer")
library("pheatmap")
library("ggplot2")

```

## Acceso a los datos
```{r data, message=FALSE, warning=FALSE}
# Cargar proyectos dispobibles en recount3
human_projects <- available_projects()

#Obtener la información del projecto específico
project_info <- subset(human_projects, project == "SRP126485" & project_type == "data_sources")

# Crear un objeto RangedSummarizedExperiment con información a nivel de genes
rse_gene_SRP126485 <- create_rse(project_info)
rse_gene_SRP126485

```

El estudio SRP126485 comprende 100 muestras provenientes de 14 individuos, evaluados en múltiples momentos bajo un diseño cruzado que considera dos condiciones: metformina y placebo. El conjunto de datos abarca mediciones de expresión correspondientes a 63 856 genes.

## Preparación de los datos

```{r trannsform_raw_count, message=FALSE, warning=FALSE}
# Convetir las lecturas por núcleotido a cuentas por lectura 
assay(rse_gene_SRP126485, "counts") <- compute_read_counts(rse_gene_SRP126485)

# Inspeccionar la infromación experimental de cada muestra
rse_gene_SRP126485$sra.sample_attributes[1:15]

# Formatear información del experimento
rse_gene_SRP126485 <-  expand_sra_attributes(rse_gene_SRP126485)
colData(rse_gene_SRP126485)[
    ,
    grepl("^sra_attribute", colnames(colData(rse_gene_SRP126485)))
]


# Filtrar tejido adiposo de músculo esquéletico
keep <- rse_gene_SRP126485$sra_attribute.tissue == "Vastus lateralis muscle"
rse_muscle <- rse_gene_SRP126485[,keep]
table(rse_muscle$sra_attribute.tissue)
dim(rse_muscle)

# Ajustar el tipo de dato de variables categóricas
rse_muscle$sra_attribute.drug <- factor(rse_muscle$sra_attribute.drug)

# Eliminar espacios antes o después del guion
rse_muscle$sra_attribute.source_name <- gsub("\\s*-\\s*", "-", 
                                             rse_muscle$sra_attribute.source_name)

rse_muscle$sra_attribute.source_name <- factor(rse_muscle$sra_attribute.source_name)

## Ajustar factor de drug para que placebo sea el baseline
rse_muscle$sra_attribute.drug <-  relevel(rse_muscle$sra_attribute.drug, "Placebo")


# Confirmar que cada individuo tenga muestras en ambas condiciones (Metformina y placebo)
table(rse_muscle$sra_attribute.subject_id, rse_muscle$sra_attribute.drug)

# Filtrar sujetos que no tengan una condición
keep_subjects <- rse_muscle$sra_attribute.subject_id != "Subject8"
rse_muscle <- rse_muscle[, keep_subjects]
```

 Las muestras correspondientes a músculo esquelético se seleccionaron utilizando la variable `sra_attribute.tissue` contenida en el objeto, conservando únicamente aquellas anotadas como tejido muscular. Durante la inspección del diseño experimental se identificó que uno de los individuos (Subject8) no contaba con muestras en ambas condiciones. Dado que el análisis se basa en comparaciones pareadas dentro de sujeto, este individuo fue excluido para mantener la consistencia del modelo. Además las variables correspondientes al individuo y al tratamiento se codificaron como factores, estableciendo placebo como la categoría de referencia para facilitar la interpretación de los análisis posteriores.

## Control de calidad 

### Profundidad de secuenciación 

```{r sequencing_depth, message=FALSE, warning=FALSE, echo=TRUE}
# Obtener las cuentas
counts <- assay(rse_muscle, "counts")
# Obtener el tamaño de librería
lib_sizes <- colSums(counts)

# Sumary
summary(lib_sizes)

# Crear data frame 
sequencing_depth <- data.frame(
    sample = colnames(rse_muscle),
    lib_size = lib_sizes,
    drug = rse_muscle$sra_attribute.drug,
    subject = rse_muscle$sra_attribute.subject_id,
    source = rse_muscle$sra_attribute.source_name
)

#Graficar 
ggplot(sequencing_depth, aes(x = drug, y = lib_size, fill = drug)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.15, alpha = 0.7) +
  labs(
    title = "Library size por tratamiento",
    x = "Tratamiento",
    y = "Número de lecturas"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5,
                              color = "#222222"),
    axis.title.y = element_text(size = 13, margin = margin(r = 12)),
    axis.text.x = element_text(size = 13, face = "bold", color = "#222222"),
    axis.text.y = element_text(size = 11, color = "#333333"),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray85", linewidth = 0.6),
    panel.grid.minor.y = element_line(color = "gray93", linewidth = 0.4),
    legend.position = "none",
    plot.background = element_rect(fill = "white", color = NA),
    panel.border = element_rect(color = "gray80", fill = NA, linewidth = 0.5)
  )

```

La mayoría de las muestras presentaron profundidades de secuenciación dentro del rango esperado para estudios de RNA-seq en humanos (mediana ≈ 16 millones de lecturas). Se identificó una muestra con un tamaño de biblioteca considerablemente menor (~0.9 millones) correspondiente a `Subject7`durante tratamiento placebo. 

### Lecturas asignadas a genes

```{r lectures_genes, message=FALSE, warning=FALSE, echo=TRUE}
# Calcular la proporción de lecturas asignadas a genes
rse_muscle$assigned_gene_prop <-
  rse_muscle$recount_qc.gene_fc_count_all.assigned /
  rse_muscle$recount_qc.gene_fc_count_all.total

# Resumen
summary(rse_muscle$assigned_gene_prop)

#Visualización
df_qc <- data.frame(
  assigned_gene_prop = rse_muscle$assigned_gene_prop
)

ggplot(df_qc, aes(x = assigned_gene_prop)) +
  geom_histogram(bins = 20, color = "black", fill = "#2C7FB8") +
  theme_bw() +
  labs(
    title = "Proporción de lecturas asignadas a genes",
    x = "Fracción de lecturas",
    y = "Número de muestras"
  )

#Filtrar muestras con pocas lescturas asignadas
rse_muscle_filtered <- rse_muscle[,rse_muscle$assigned_gene_prop > 0.3]

# Filtrar sujetos
tab <- table(rse_muscle_filtered$sra_attribute.subject_id,
             rse_muscle_filtered$sra_attribute.drug)

# Sujetos con ambas condiciones
complete_subjects <- rownames(tab)[rowSums(tab > 0) == 2]

rse_muscle_filtered <- rse_muscle_filtered[,
  rse_muscle_filtered$sra_attribute.subject_id %in% complete_subjects
]

table(rse_muscle_filtered$sra_attribute.subject_id, rse_muscle_filtered$sra_attribute.drug)
```

Se eliminaron los sujetos 5 y 14 debido a que tras el filtrado no contaban con muestras en ambas condiciones.


### Filtrado de genes 

```{r}
# Obtener counts
counts_muscle_filtered <- assay(rse_muscle_filtered, "counts")

# Crear DGEList primero
dge <- DGEList(counts = counts_muscle_filtered, genes = rowData(rse_muscle_filtered))

# Crear metadata correctamente
meta <- data.frame(
  group   = factor(rse_muscle_filtered$sra_attribute.drug),
  subject = factor(rse_muscle_filtered$sra_attribute.subject_id),
  visit   = factor(rse_muscle_filtered$sra_attribute.source_name)
)

# IMPORTANTE: rownames deben coincidir con columnas de counts
rownames(meta) <- colnames(dge)

# Diseño para filtrado
design <- model.matrix(~ group, meta)

# Filtrar genes
keep_genes <- filterByExpr(dge, design = design)
dge <- dge[keep_genes, , keep.lib.sizes = FALSE]

#Obtener nombres de genes filtrados
gene_info <- as.data.frame(rowData(rse_muscle_filtered))
gene_info_filtered <- gene_info[keep_genes, ]

dge$genes <- data.frame(
  ENSEMBL = rownames(dge),
  SYMBOL  = gene_info_filtered$gene_name
)

# Número de genes filtrados
num_genes_retenidos <- sum(keep_genes)
num_genes_totales <- nrow(counts_muscle_filtered)

# Porcentaje de genes retenidos
porcentaje_genes <- (num_genes_retenidos / num_genes_totales) * 100

cat("Genes retenidos:", num_genes_retenidos, "\n")
cat("Total de genes:", num_genes_totales, "\n")
cat(sprintf("Porcentaje de genes retenidos: %.2f%%\n", porcentaje_genes))
```


### Exploración de varianza

```{r}

colores <- c("#3dd0eeff", "#FF7F7F")
plotMDS(dge, 
        col = colores[as.numeric(meta$group)],
        pch = 16,
        cex = 1.5,
        main = "MDS por tratamiento",
        xlab = "Dimensión 1",
        ylab = "Dimensión 2")

# Añadir leyenda mejorada
legend("topright", 
       legend = levels(meta$group),
       col = colores[1:length(levels(meta$group))], 
       pch = 16,
       cex = 0.8,
       title = "Tratamiento",
       bty = "o",           # Con borde
       bg = "white",        # Fondo blanco
       box.lwd = 1)         # Grosor del borde
```

El análisis de escalamiento multidimensional (MDS) no mostró una separación evidente entre las condiciones de metformina y placebo en los primeros componentes principales. Dado que el MDS sugiere la presencia de múltiples fuentes de variabilidad en los datos, se procedió a realizar un análisis de partición de varianza mediante modelos lineales mixtos para cuantificar formalmente la contribución relativa del sujeto y del tratamiento a la variación transcriptómica observada.

```{r}
form_vp <- ~ (1|group) + (1|subject) + (1|visit)
vobj <- voomWithDreamWeights(dge, form_vp, meta, BPPARAM = param)
vp <- fitExtractVarPartModel(vobj, form_vp, meta, BPPARAM = param)
plotVarPart(vp)
```


Para evaluar la contribución de las variables experimentales a la varianza global de los datos de expresión génica, se realizó un análisis de partición de la varianza. El factor 'subject' (sujeto) emergió como una fuente significativa de variación, explicando una proporción sustancial de la varianza en un gran número de genes, lo que justifica su inclusión en el modelo lineal para controlar la heterogeneidad interindividual. Por el contrario, las variables 'group' (grupo) y 'visit' (visita) mostraron una contribución marginal a la varianza total en la mayoría de los genes. Cabe destacar que se observó una fracción elevada de varianza residual, lo que sugiere la presencia de ruido técnico o biológico no capturado por el diseño inicial, subrayando la importancia de emplear métodos robustos de normalización y filtrado antes del análisis de expresión diferencial


### Análisis de expresión diferencial

```{r}
form_de <- ~ group + (1|subject)
param <- SerialParam(progressbar = TRUE)
vobj_de <- voomWithDreamWeights(dge, form_de, meta, BPPARAM = param, plot=TRUE)
fit <- dream(vobj_de, form_de, meta, BPPARAM = param)
fit <- eBayes(fit)
res <- topTable(fit, coef = "groupMetformin", number = Inf, sort.by = "P")
head(res)
```


```{r}

df <- data.frame(
  AveExpr = res$AveExpr,
  logFC = res$logFC,
  P = res$P.Value,
  FDR = res$adj.P.Val
)

df$Significant <- df$FDR < 0.05

ggplot(df, aes(AveExpr, logFC)) +
  
  # No significativos
  geom_point(data = subset(df, Significant == FALSE),
             color = "grey75",
             alpha = 0.5,
             size = 1) +
  
  # Significativos encima
  geom_point(data = subset(df, Significant == TRUE),
             color = "#ff3c3cff", 
             alpha = 0.9,
             size = 1.3) +
  
  # Línea central
  geom_hline(yintercept = 0,
             color = "black",
             linewidth = 0.6) +
  
  # Umbral biológico ±1
  geom_hline(yintercept = c(-1,1),
             linetype = "dashed",
             color = "black",
             linewidth = 0.4) +
  
  theme_classic(base_size = 14) +
  labs(title = "MA Plot: Metformin vs Placebo",
       x = "Average log-expression",
       y = "Log2 Fold Change") +
  theme(legend.position = "none")
```


```{r}
# Volcanoplot

res$Category <- "NS"

# Primero los verdaderamente DE
res$Category[res$logFC > 1 & res$adj.P.Val < 0.05] <- "UP"
res$Category[res$logFC < -1 & res$adj.P.Val < 0.05] <- "DOWN"

# Luego los parciales
res$Category[abs(res$logFC) > 1 & res$adj.P.Val >= 0.05] <- "logFC"
res$Category[abs(res$logFC) <= 1 & res$adj.P.Val < 0.05] <- "p-value"


keyvals <- c(
  NS = "grey85",
  logFC = "#e0d688ff",
  `p-value` = "#a186c4ff",
  UP = "#FF7F7F",
  DOWN = "#3dd0eeff"
)

colCustom <- keyvals[res$Category]


# R
EnhancedVolcano(
  res,
  lab = ifelse(is.na(res$SYMBOL) | res$SYMBOL == "", rownames(res), res$SYMBOL),
  x = "logFC",
  y = "adj.P.Val",
  xlim = c(-2, 2),
  ylim = c(0, 5.5),
  ylab = expression(-Log[10]~adj~P),
  pCutoff = 0.05,
  FCcutoff = 1,
  selectLab = c("PDK4", "TAS2R46", "SLC1A1", "HLA-DOA", "HOXD4", "BEX4", "CCL5", "RNF43", "GAPDHP42", "HRASLS5", "PPARGC1A", "SLC2A4", "PCK1", "RET"),
  xlab = bquote(~Log[2]~ 'fold change'),
  labSize = 3.5,
  labCol = "black",
  labFace = "bold",
  boxedLabels = TRUE,
  drawConnectors = TRUE,
  widthConnectors = 0.5,
  colConnectors = "black",
  cutoffLineType = "twodash",
  pointSize = 2.5,
  colCustom = colCustom,
  cutoffLineWidth = 0.8,
  title = "Metformin vs Placebo",
  subtitle = "Expresión diferencial en músculo esquelético",
  caption = paste0(sum(res$Category == "UP"), " upregulated; ",
                   sum(res$Category == "DOWN"), " downregulated")
)
```

```{r}
# Guardar resultados 
UP_genes   <- res[res$Category == "UP", ]
DOWN_genes <- res[res$Category == "DOWN", ]
FDR_only <- res[res$Category == "p-value", ]

nrow(UP_genes)
nrow(DOWN_genes)
nrow(FDR_only)
```

```{r}

n_top <- 25

top_up <- UP_genes[order(UP_genes$adj.P.Val), ][1:n_top, ]
top_down <- DOWN_genes[order(DOWN_genes$adj.P.Val), ][1:n_top, ]

selected_genes <- rbind(top_up, top_down)

# Extraer expresión normalizada
heatmap_data <- vobj_de$E[rownames(selected_genes), ]

rownames(heatmap_data) <- res[rownames(selected_genes), "SYMBOL"]

# Anotación de genes
gene_annotation <- data.frame(
  Regulation = ifelse(selected_genes$logFC > 0, "Up", "Down"),
  row.names = rownames(heatmap_data)
)

# Anotación de muestras
sample_annotation <- data.frame(
  Treatment = meta$group,
  Visits = meta$visit
)
rownames(sample_annotation) <- colnames(heatmap_data)

# Ordenar filas por logFC (Up primero, Down después)
heatmap_data <- heatmap_data[order(selected_genes$logFC, decreasing = TRUE), ]

# Plot con colores por defecto
pheatmap(
  heatmap_data,
  scale = "row",
  clustering_method = "ward.D2",
  annotation_row = gene_annotation,
  annotation_col = sample_annotation,
  main = paste("Top", n_top, "up y", n_top, "down genes"),
  fontsize_row = 8,
  fontsize_col = 10
)
```


